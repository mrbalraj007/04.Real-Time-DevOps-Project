// JENKINS CD PIPELINE
// Here the image stored in Dockerhub will be deployed using K8s
// IMP NOTE: Store your EC2 instance username & key in Jenkins credentials

pipeline {
    agent any
    environment {
        NODE_IP = '172.31.29.51'  // <Node_Server_Private_IP> paste your Node-Server private IP here
        EC2_NAME = "ec2-user"     // enter your AWS EC2 username
        PIPELINE_NAME = "CI-PIPELINE"  // enter your pipeline name here 
        }

    stages {
        stage("1. Pull Files") {
            steps {
                sshagent(['my_ec2_creds']) {  // ensure this credential ID exists in Jenkins
                    // Copy K8s manifest files from Master-Server workspace to Node-server
                    sh """
                    scp -o StrictHostKeyChecking=no /var/lib/jenkins/workspace/${PIPELINE_NAME}/deployment.yaml ${EC2_NAME}@${NODE_IP}:/home/ec2-user/
                    scp -o StrictHostKeyChecking=no /var/lib/jenkins/workspace/${PIPELINE_NAME}/service.yaml ${EC2_NAME}@${NODE_IP}:/home/ec2-user/
                    """
                }
            }
        }
    }
}
